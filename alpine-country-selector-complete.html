<!-- ============================================
     ALPINE.JS COUNTRY SELECTOR - COMPLETE IMPLEMENTATION
     ============================================

     This file contains:
     1. HTML replacement for the country field (lines 15-90)
     2. JavaScript Alpine.js component (lines 95-280)

     INSTRUCTIONS:
     1. Replace lines 474-488 in attendee.html with HTML section below
     2. Replace lines 766-815 in attendee.html with JavaScript section below
     ============================================ -->


<!-- ============================================
     PART 1: HTML REPLACEMENT
     Replace the <div> containing form.country (around line 474-488)
     ============================================ -->

<!-- Country Selector with Alpine.js -->
<div x-data="countrySelector()" x-init="init()">
    {{ form.country.label(class="block text-sm font-medium text-primary-dark mb-1") }}

    <!-- Custom Searchable Dropdown -->
    <div class="relative">
        <!-- Display Input -->
        <div class="relative">
            <input
                type="text"
                x-model="search"
                @click="open = true"
                @keydown.escape="open = false"
                @keydown.arrow-down.prevent="focusNext()"
                @keydown.arrow-up.prevent="focusPrevious()"
                @keydown.enter.prevent="selectFocused()"
                placeholder="Search or select your country"
                class="w-full px-3.5 py-2 border border-gray-300 rounded-md focus:ring-accent-yellow focus:border-accent-yellow"
                autocomplete="off"
            />
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>

        <!-- Dropdown List -->
        <div
            x-show="open && filteredCountries.length > 0"
            @click.outside="open = false"
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="transform opacity-0 scale-95"
            x-transition:enter-end="transform opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="transform opacity-100 scale-100"
            x-transition:leave-end="transform opacity-0 scale-95"
            class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"
            style="display: none;"
        >
            <template x-for="(country, index) in filteredCountries" :key="country">
                <div
                    @click="selectCountry(country)"
                    @mouseenter="focusedIndex = index"
                    :class="{
                        'bg-accent-yellow text-primary-dark': focusedIndex === index,
                        'hover:bg-gray-100': focusedIndex !== index
                    }"
                    class="px-3.5 py-2 cursor-pointer transition-colors"
                    x-text="country"
                ></div>
            </template>
        </div>

        <!-- No results message -->
        <div
            x-show="open && search && filteredCountries.length === 0"
            class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg p-3"
            style="display: none;"
        >
            <p class="text-sm text-gray-500">No countries found matching "<span x-text="search"></span>"</p>
        </div>
    </div>

    <!-- Hidden select field (actual form field) -->
    {{ form.country(style="display: none;", **{"x-ref": "hiddenSelect"}) }}

    <!-- Error display -->
    {% if form.country.errors %}
    <p class="text-red-600 text-xs mt-1">
        {{ form.country.errors[0] }}
    </p>
    {% endif %}
</div>


<!-- ============================================
     PART 2: JAVASCRIPT REPLACEMENT
     Replace the script content in {% block scripts %} (around line 766-815)
     Keep the <script> tags and {% block scripts %}/{% endblock %}
     ============================================ -->

<script>
    /**
     * Alpine.js Country Selector Component
     */
    function countrySelector() {
        return {
            // Component state
            open: false,
            search: '',
            selectedCountry: '',
            focusedIndex: 0,

            // Comprehensive country list (195 countries)
            countries: [
                'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola',
                'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria',
                'Azerbaijan', 'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados',
                'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan',
                'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei',
                'Bulgaria', 'Burkina Faso', 'Burundi', 'Cabo Verde', 'Cambodia',
                'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile',
                'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica',
                'Croatia', 'Cuba', 'Cyprus', 'Czech Republic', 'Denmark',
                'Djibouti', 'Dominica', 'Dominican Republic', 'DR Congo', 'Ecuador',
                'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia',
                'Eswatini', 'Ethiopia', 'Fiji', 'Finland', 'France',
                'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana',
                'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau',
                'Guyana', 'Haiti', 'Honduras', 'Hungary', 'Iceland',
                'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland',
                'Israel', 'Italy', 'Ivory Coast', 'Jamaica', 'Japan',
                'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Kosovo',
                'Kuwait', 'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon',
                'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania',
                'Luxembourg', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives',
                'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius',
                'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia',
                'Montenegro', 'Morocco', 'Mozambique', 'Myanmar', 'Namibia',
                'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua',
                'Niger', 'Nigeria', 'North Korea', 'North Macedonia', 'Norway',
                'Oman', 'Pakistan', 'Palau', 'Palestine', 'Panama',
                'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland',
                'Portugal', 'Qatar', 'Romania', 'Russia', 'Rwanda',
                'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines',
                'Samoa', 'San Marino', 'Sao Tome and Principe', 'Saudi Arabia',
                'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore',
                'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia', 'South Africa',
                'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan',
                'Suriname', 'Sweden', 'Switzerland', 'Syria', 'Taiwan',
                'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo',
                'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan',
                'Tuvalu', 'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom',
                'United States', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Vatican City',
                'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'
            ],

            // Computed property: Filtered countries based on search
            get filteredCountries() {
                if (!this.search) {
                    return this.countries;
                }
                const searchLower = this.search.toLowerCase();
                return this.countries.filter(country =>
                    country.toLowerCase().includes(searchLower)
                );
            },

            // Initialize component
            init() {
                // Check if there's a pre-selected value (e.g., form validation error)
                const hiddenSelect = this.$refs.hiddenSelect;
                if (hiddenSelect && hiddenSelect.value) {
                    this.selectedCountry = hiddenSelect.value;
                    this.search = hiddenSelect.value;
                }

                // Set up phone input listener for auto-selection
                this.setupPhoneInputListener();

                // Watch for changes to sync with hidden select
                this.$watch('selectedCountry', (value) => {
                    if (this.$refs.hiddenSelect) {
                        this.$refs.hiddenSelect.value = value;
                    }
                });
            },

            // Select a country
            selectCountry(country) {
                this.selectedCountry = country;
                this.search = country;
                this.open = false;
                this.focusedIndex = 0;

                // Update hidden select field
                if (this.$refs.hiddenSelect) {
                    this.$refs.hiddenSelect.value = country;

                    // Trigger change event for any listeners
                    const event = new Event('change', { bubbles: true });
                    this.$refs.hiddenSelect.dispatchEvent(event);
                }
            },

            // Keyboard navigation: Focus next item
            focusNext() {
                if (!this.open) {
                    this.open = true;
                    return;
                }
                this.focusedIndex = Math.min(
                    this.focusedIndex + 1,
                    this.filteredCountries.length - 1
                );
            },

            // Keyboard navigation: Focus previous item
            focusPrevious() {
                if (!this.open) {
                    this.open = true;
                    return;
                }
                this.focusedIndex = Math.max(this.focusedIndex - 1, 0);
            },

            // Keyboard navigation: Select focused item
            selectFocused() {
                if (this.open && this.filteredCountries[this.focusedIndex]) {
                    this.selectCountry(this.filteredCountries[this.focusedIndex]);
                }
            },

            // Auto-select country based on phone input
            setupPhoneInputListener() {
                const phoneInput = document.getElementById('phone_international');
                if (!phoneInput) return;

                // Listen for country change from intl-tel-input
                phoneInput.addEventListener('countrychange', () => {
                    if (!window.intlTelInputGlobals) return;

                    const iti = window.intlTelInputGlobals.getInstance(phoneInput);
                    if (!iti) return;

                    const countryData = iti.getSelectedCountryData();
                    if (!countryData || !countryData.name) return;

                    // Map intl-tel-input country name to our list
                    const countryName = this.mapPhoneCountryToList(countryData.name);

                    if (countryName && this.countries.includes(countryName)) {
                        this.selectCountry(countryName);
                    }
                });
            },

            // Map phone input country names to our country list
            mapPhoneCountryToList(phoneCountry) {
                // Direct match
                if (this.countries.includes(phoneCountry)) {
                    return phoneCountry;
                }

                // Common variations/aliases
                const countryMap = {
                    'United States of America': 'United States',
                    'USA': 'United States',
                    'UK': 'United Kingdom',
                    'Great Britain': 'United Kingdom',
                    'UAE': 'United Arab Emirates',
                    'DRC': 'DR Congo',
                    'Democratic Republic of the Congo': 'DR Congo',
                    'Republic of the Congo': 'Congo',
                    'South Korea (Republic of Korea)': 'South Korea',
                    'North Korea (Democratic People\'s Republic of Korea)': 'North Korea',
                    'The Netherlands': 'Netherlands',
                    'The Bahamas': 'Bahamas',
                    'The Gambia': 'Gambia',
                    'Republic of Ireland': 'Ireland',
                    'People\'s Republic of China': 'China',
                    'Russian Federation': 'Russia',
                    'Republic of China (Taiwan)': 'Taiwan'
                };

                return countryMap[phoneCountry] || phoneCountry;
            }
        };
    }
</script>
